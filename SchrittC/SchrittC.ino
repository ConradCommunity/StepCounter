/**************************************************************************
   Copyright (c) 2015 Intel Corporation.  All rights reserved.

   This library is free software; you can redistribute it and/or
   modify it under the terms of the GNU Lesser General Public
   License as published by the Free Software Foundation; either
   version 2.1 of the License, or (at your option) any later version.

   This library is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
   Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public
   License along with this library; if not, write to the Free Software
   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA

   This sketch example demonstrates how the BMI160 accelerometer on the
   Intel(R) Curie(TM) module can be used as a Step Counter (pedometer)

   To get an interrupt notification for every step detected,
   set stepEventsEnabeled to true. Otherwise, the main loop will
   poll for the current step count.

   By design, the step counter does not immediately update on every step detected.
   Please refer to Section 2.7 of the BMI160 IMU SensorData Sheet
   for more information on this feature.
**************************************************************************/

#include "Arduino.h"
#include "Wire.h"
#include "SeeedGrayOLED.h"
#include <avr/pgmspace.h>
#include "CurieImu.h"

const int ledPin = 13;

boolean stepEventsEnabeled = true;   // whether you're polling or using events
long lastStepCount = 0;              // step count on previous polling check
boolean blinkState = false;          // state of the LED

static unsigned char brain[] PROGMEM = {
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFC, 0x00, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x0F,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x80, 0x00, 0x00, 0x03, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,
0x00, 0x00, 0x00, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0x00, 0x00, 0x00, 0x00,
0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xE0, 0x00, 0xF0, 0x00, 0x00, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0,
0x03, 0xFC, 0x3F, 0xC0, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x80, 0x03, 0xFC, 0x7F, 0xE0,
0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x07, 0xFC, 0x7E, 0x70, 0x01, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFE, 0x00, 0x07, 0x9C, 0x7C, 0x30, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x00,
0x07, 0x1C, 0x7C, 0x70, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x00, 0xC7, 0x04, 0x40, 0x78,
0x00, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0x01, 0xC7, 0x80, 0x00, 0x78, 0x00, 0x3F, 0xFF, 0xFF,
0xFF, 0xFF, 0xF8, 0x01, 0xC7, 0xC0, 0x00, 0x7F, 0x00, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x03,
0xC3, 0xF0, 0x3C, 0x3F, 0xC0, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x03, 0xE1, 0xFC, 0x7E, 0x1F,
0xE0, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x07, 0xE0, 0x3C, 0x7F, 0x3C, 0xF0, 0x0F, 0xFF, 0xFF,
0xFF, 0xFF, 0xE0, 0x07, 0xC0, 0x1C, 0x7F, 0xF8, 0x78, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x07,
0x84, 0x1C, 0x73, 0xF8, 0xF8, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x03, 0x8F, 0xFC, 0x70, 0xF0,
0xFC, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x07, 0x8F, 0xFC, 0x70, 0x00, 0x3C, 0x07, 0xFF, 0xFF,
0xFF, 0xFF, 0xC0, 0x0F, 0x9F, 0xFC, 0x78, 0x00, 0x1C, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x1F,
0xFE, 0x00, 0x78, 0x04, 0x1C, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x31, 0xFC, 0x00, 0x78, 0xFF,
0xB8, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0x80, 0x71, 0xF8, 0x00, 0x70, 0xFF, 0xF8, 0x03, 0xFF, 0xFF,
0xFF, 0xFF, 0x80, 0x70, 0x70, 0xFC, 0x71, 0xFF, 0xF0, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0x80, 0x70,
0x01, 0xFC, 0x71, 0xC3, 0xE0, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0x80, 0x60, 0x03, 0xFC, 0x7F, 0x83,
0x80, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0x80, 0x61, 0x03, 0xFC, 0x7F, 0x87, 0x00, 0x03, 0xFF, 0xFF,
0xFF, 0xFF, 0x80, 0x67, 0xC7, 0x1C, 0x7F, 0x0F, 0x0C, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0x80, 0x7F,
0xE7, 0x1C, 0x3F, 0x1F, 0x3C, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x7C, 0xFE, 0x3C, 0x00, 0x0F,
0xFC, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x38, 0x7C, 0x3C, 0x00, 0x03, 0xBE, 0x03, 0xFF, 0xFF,
0xFF, 0xFF, 0xC0, 0x1C, 0x10, 0x1C, 0x40, 0x40, 0x1E, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x1E,
0x00, 0x00, 0x7F, 0xE0, 0x1E, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x3F, 0x00, 0x00, 0x7F, 0xF8,
0x3C, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x3E, 0x03, 0xC0, 0x7F, 0xFF, 0xFC, 0x03, 0xFF, 0xFF,
0xFF, 0xFF, 0xE0, 0x3C, 0x1F, 0xFC, 0x7F, 0xFF, 0xF8, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x1C,
0x7F, 0xFC, 0x1F, 0x9F, 0xE0, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x1F, 0xF3, 0xC4, 0x07, 0x0F,
0x00, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x1F, 0xC0, 0x04, 0x03, 0x86, 0x00, 0x03, 0xFF, 0xFF,
0xFF, 0xFF, 0xF8, 0x0F, 0x80, 0x04, 0x41, 0xC7, 0x00, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0x07,
0x80, 0x0C, 0x71, 0xC3, 0x80, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x01, 0x8E, 0x3C, 0x70, 0xE2,
0x00, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x00, 0x1E, 0x3C, 0x78, 0xE0, 0x00, 0x03, 0xFF, 0xFF,
0xFF, 0xFF, 0xFE, 0x00, 0x0E, 0x1C, 0x78, 0xE0, 0x00, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
0x0F, 0x1C, 0x7F, 0xE0, 0x00, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x80, 0x0F, 0xFC, 0x7F, 0xE0,
0x00, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x07, 0xFC, 0x3F, 0x80, 0x00, 0x03, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xE0, 0x00, 0x70, 0x00, 0x00, 0x0C, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0,
0x00, 0x00, 0x00, 0x00, 0x1E, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0x00, 0x00, 0x00, 0x00,
0x3E, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x83, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x01, 0xFF, 0x83, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xC0, 0x00, 0x00, 0x07, 0xFF, 0xE3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x1F,
0xFF, 0xE3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x00, 0x00, 0x7F, 0xFF, 0xF3, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x0F, 0xFF, 0xFF, 0xFB, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
};

void setup() 
{
  Wire.begin(); 
  
  SeeedGrayOled.init();                         // initialize SEEED Gray OLED display

  SeeedGrayOled.clearDisplay();                 // clear the screen and set start position to top left corner
  SeeedGrayOled.setInverseDisplay();
  
  SeeedGrayOled.drawBitmap(brain,96*96/8);      //  Draw binary Bitmap (96 pixels *96 pixels  / 8) bytes
  
  delay(5000);
  
  SeeedGrayOled.setNormalDisplay();             // Set display to Normal mode  
  SeeedGrayOled.clearDisplay();  
  SeeedGrayOled.setVerticalMode();              // Set to vertical mode for displaying text

  // User-LED "L"  
  pinMode(13,OUTPUT);
  
  // intialize the sensor:
  CurieImu.initialize();
  
  // turn on step detection mode:
  CurieImu.setStepDetectionMode(BMI160_STEP_MODE_NORMAL);
  
  // enable step counting:
  CurieImu.setStepCountEnabled(true);

  if (stepEventsEnabeled) 
  {
    // attach the eventCallback function as the
    // step event handler:
    CurieImu.attachInterrupt(eventCallback);
    CurieImu.setIntStepEnabled(true);           // turn on step detection
    CurieImu.setIntEnabled(true);               // enable interrupts

    SeeedGrayOled.setTextXY(0,0);               // Set the cursor to 0th line, 0th Column  
    SeeedGrayOled.putString("Conrad");
    SeeedGrayOled.setTextXY(1,0);      
    SeeedGrayOled.putString("Community");

    SeeedGrayOled.setTextXY(4,0);      
    SeeedGrayOled.putString("Steps:");
    
    SeeedGrayOled.setTextXY(5,0);      
    SeeedGrayOled.putString("0");
  }
}

void loop() 
{
  // Instead of using step detection event notifications,
  // we can check the step count periodically
  if (!stepEventsEnabeled) 
  {
    updateStepCount();
  }
  
  digitalWrite(13, blinkState);
  blinkState = !blinkState;
  delay(1000);
}

static void updateStepCount() 
{
  // get the step count:
  int stepCount = CurieImu.getStepCount();
  
  // if the step count has changed, print it:
  if (stepCount != lastStepCount) 
  {
    SeeedGrayOled.setTextXY(5,0);      
    SeeedGrayOled.putNumber(stepCount);
    
    // save the current count for comparison next check:
    lastStepCount = stepCount;
  }
}

static void eventCallback(void) 
{
  if (CurieImu.getIntStepStatus())
    updateStepCount();
}
